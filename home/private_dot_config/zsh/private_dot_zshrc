#!usr/bin/zsh

#===============================================Debug zsh startup time header===============================================#
#ğŸ”—ï¼šhttps://gist.github.com/elalemanyo/cb3395af64ac23df2e0c3ded8bd63b2f
# For debugging the zsh launch time
if [ -n "${ZSH_DEBUGRC+1}" ]; then
    zmodload zsh/zprof
fi

#===============================================Personal scripts===============================================#
#
source $ZDOTDIR/env.zsh
source $ZDOTDIR/functions.zsh
source $ZDOTDIR/alias.zsh

#==============================================Module Configurations===============================================#
#
# Remove older command from the history if a duplicate is to be added.
setopt HIST_IGNORE_ALL_DUPS

# ä½¿ç”¨zsh-auto-pairæ’ä»¶æ—¶ï¼Œåˆ é™¤é”®ä¸èƒ½è‡ªåŠ¨åˆ é™¤åŒ¹é…çš„åˆ†éš”ç¬¦ï¼ŒåŸå› æ˜¯zsh-vim-modeçš„lazy-loading æœºåˆ¶
  # ğŸ”—ï¼šhttps://github.com/hlissner/zsh-autopair/issues/33#issuecomment-1476706761
ZVM_INIT_MODE=sourcing
ZVM_LAZY_KEYBINDINGS=false
# zvm_after_init_commands=(autopair-init)
# Remove path separator from WORDCHARS.
WORDCHARS=${WORDCHARS//[\/]}
#
# input module
# Append `../` to your input for each `.` you type after an initial `..`
# é¦–å…ˆè¦åœ¨zimrcä¸­å¼€å¯input module
# zstyle ':zim:input' double-dot-expand yes

# zsh-autosuggestions
# Disable automatic widget re-binding on each precmd. This can be set when zsh-users/zsh-autosuggestions is the last module in your ~/.zimrc.
# ZSH_AUTOSUGGEST_MANUAL_REBIND=1

# zsh-syntax-highlighting
# See https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/docs/highlighters.md
ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets line)


# completion
# å°†åŠ é€Ÿè¡¥å…¨äº§ç”Ÿçš„.zcompdumpæ–‡ä»¶ï¼Œä¿å­˜åˆ°.cacheæ–‡ä»¶å¤¹ä¸­ï¼Œè€Œéå®¶ç›®å½•ä¸­
zstyle ':completion::complete:*' cache-path ${XDG_CACHE_HOME}/zsh/zcompcache

# zsh-vi-mode
# ğŸ”—: https://github.com/jeffreytse/zsh-vi-mode
ZVM_VI_SURROUND_BINDKEY=s-prefix

# Only changing the escape key to `jk` in insert mode, we still keep using the default keybindings `^[` in other modes
ZVM_VI_INSERT_ESCAPE_BINDKEY=jk

#===============================================Zimfw Initialize===============================================#
#
ZIM_HOME=${ZDOTDIR:-${HOME}}/.zim
# Download zimfw plugin manager if missing.
if [[ ! -e ${ZIM_HOME}/zimfw.zsh ]]; then
  if (( ${+commands[curl]} )); then
    curl -fsSL --create-dirs -o ${ZIM_HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  else
    mkdir -p ${ZIM_HOME} && wget -nv -O ${ZIM_HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  fi
fi

# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZDOTDIR:-${HOME}}/.zimrc ]]; then
  source ${ZIM_HOME}/zimfw.zsh init -q
fi
# Initialize modules.
source ${ZIM_HOME}/init.zsh

#===============================================zsh-history-substring-search===============================================#
#
# zmodload -F zsh/terminfo +p:terminfo
# Bind ^[[A/^[[B manually so up/down works both before and after zle-line-init
# for key ('^[[A' '^P' ${terminfo[kcuu1]}) bindkey ${key} history-substring-search-up
# for key ('^[[B' '^N' ${terminfo[kcud1]}) bindkey ${key} history-substring-search-down
# for key ('k') bindkey -M vicmd ${key} history-substring-search-up
# for key ('j') bindkey -M vicmd ${key} history-substring-search-down
# unset key

#===============================================pipx auto-completion===============================================#
# enable completion for pipx:
eval "$(register-python-argcomplete pipx)"
#
#===============================================zellij configuration===============================================#
#
# å¦‚æœå¯åŠ¨çš„ç»ˆç«¯æ˜¯Alacrittyï¼Œå°±è‡ªåŠ¨è‡ªåŠ¨å¯åŠ¨zellij
# if [[ "$TERM" == "alacritty" ]]
# then
# 	eval "$(zellij setup --generate-auto-start zsh)"
# fi
#
#===============================================Debug zsh startup time footer===============================================#
#
if [ -n "${ZSH_DEBUGRC+1}" ]; then
    zprof
fi
# run follow command to measure zsh startup time.
# `time ZSH_DEBUGRC=1 zsh -i -c exit`
  # æœ€ç»ˆçš„è¾“å‡ºå¦‚ä¸‹ï¼š
    # ZSH_DEBUGRC=1 zsh -i -c exit  0.04s user 0.02s system 100% cpu 0.066 total
      # 0.04s user: è¿™è¡¨ç¤ºåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ï¼ŒZsh æ‰§è¡Œè¯¥å‘½ä»¤èŠ±è´¹äº† 0.04 ç§’ã€‚ç”¨æˆ·æ¨¡å¼æ˜¯æŒ‡ CPU æ‰§è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ã€‚
      # 0.02s system: è¿™è¡¨ç¤ºåœ¨å†…æ ¸æ¨¡å¼ä¸‹ï¼ŒZsh æ‰§è¡Œè¯¥å‘½ä»¤èŠ±è´¹äº† 0.02 ç§’ã€‚ç³»ç»Ÿæ¨¡å¼æ˜¯æŒ‡ CPU æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´ã€‚
      # 100% cpu: è¿™è¡¨ç¤ºåœ¨æ‰§è¡Œè¯¥å‘½ä»¤æ—¶ï¼ŒCPU çš„ä½¿ç”¨ç‡è¾¾åˆ°äº† 100%ã€‚è¿™é€šå¸¸æ„å‘³ç€åœ¨æ‰§è¡Œå‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼ŒCPU çš„èµ„æºè¢«å®Œå…¨åˆ©ç”¨ã€‚
      # 0.066 total: è¿™è¡¨ç¤ºä»å¼€å§‹åˆ°ç»“æŸçš„æ€»æ—¶é—´ä¸º 0.066 ç§’ã€‚è¿™æ˜¯ Zsh å¯åŠ¨å¹¶æ‰§è¡Œ exit å‘½ä»¤æ‰€èŠ±è´¹çš„æ€»æ—¶é—´ã€‚
      #
#===============================================zsh-vim-modeè‡ªåŠ¨åˆ‡æ¢è¾“å…¥æ³•===============================================#
# åœ¨é€‰æ‹©vim-modeæ¨¡å¼ï¼ˆnormal,insert,visualï¼‰å‰éœ€è¦æ‰§è¡Œçš„æ“ä½œ
# function zvm_before_select_vi_mode() {
#   # åœ¨é€€å‡ºinsertæ¨¡å¼ä¹‹å‰ï¼š
#   if [[ $ZVM_MODE == $ZVM_MODE_INSERT ]]; then
#     # ä¿å­˜å½“å‰è¾“å…¥æ³•çš„çŠ¶æ€
#
#     get_im_status
#     # ç„¶ååˆ‡æ¢åˆ°æŒ‡å®šçš„vim mode
#     switch_to_vim
#   fi
# }
# 
# # è¿›å…¥insertæ¨¡å¼åï¼š
# function zvm_after_select_vi_mode() {
#   if [[ $ZVM_MODE == $ZVM_MODE_INSERT ]]; then
#     # åˆ‡æ¢åˆ°ä¹‹å‰çš„è¾“å…¥æ³•çŠ¶æ€
#     switch_to_origin
#   fi
#}
